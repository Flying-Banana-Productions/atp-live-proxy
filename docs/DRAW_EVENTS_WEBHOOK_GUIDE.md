# ATP Live Proxy - Draw Events Webhook Guide

## Overview

The ATP Live Proxy generates comprehensive draw events from the `/api/draws/live` endpoint, providing real-time tournament draw progression tracking. These events are generated by comparing changes in tournament draw data over time, detecting match completions, player advancements, and tournament milestones.

The system monitors the ATP API's draw data structure (`Associations[] → Events[] → Rounds[] → Fixtures[]`) and generates specific events when key changes occur, such as when a match winner is determined (`Winner: 0 → 1/2`) or when players advance to the next round (`IsTopKnown/IsBottomKnown: false → true`).

## Schema Changes Summary

### Recent Improvements (v2.0.0)
1. **Consolidated match events**: `draw_match_completed` and `draw_match_walkover` merged into single `draw_match_result` event with `resultType` field
2. **Normalized player objects**: All player fields now use consistent object structure with `name` and `playerId`
3. **Enhanced tournament context**: Added structured `tournament` and `round` objects with comprehensive metadata
4. **Simplified player data**: Removed `nationality`, `seed`, and `ranking` fields (clients can look these up separately)

### Latest Updates (v2.1.0)
1. **Doubles support enhanced**: All doubles players now properly included in `players` array
2. **Team identification**: Added `teamId` field to all player objects (1 for top/first team, 2 for bottom/second team)
3. **Consistent team tracking**: `teamId` included for both singles and doubles matches for uniformity
4. **Space-saving doubles naming**: Doubles matches use first initials (e.g., "V. Cornea") to reduce text length
5. **Live match event consistency**: Live match events now include `teamId` field for complete data uniformity

## Event Types & Schemas

### 1. `draw_match_result`

**When triggered:** A match in the draw completes (Winner field changes from 0 to 1 or 2)  
**Priority:** Medium  
**Description:** Generated when a match finishes, either normally or via walkover/retirement

**Example:**
```json
{
  "event_type": "draw_match_result",
  "event_timestamp": "2025-08-26T13:10:41.577Z",
  "tournament_id": "3473",
  "match_id": "QS009",
  "description": "Draw match completed: Inaki Montes-De La Torre vs Gabriele Pennaforti - Gabriele Pennaforti wins 6/2 4/6 6/3",
  "data": {
    "resultType": "completed",  // or "walkover" for retirements/walkovers
    "players": [
      {
        "name": "Inaki Montes-De La Torre",
        "playerId": "M0NL",
        "teamId": 1
      },
      {
        "name": "Gabriele Pennaforti",
        "playerId": "P0JG",
        "teamId": 2
      }
    ],
    "winner": {
      "name": "Gabriele Pennaforti",
      "playerId": "P0JG",
      "teamId": 2
    },
    "score": "6/2 4/6 6/3",
    "tournament": {
      "id": "3473",
      "name": "Como, ITA",
      "phase": "qualifying",  // or "main_draw"
      "drawSize": 24,
      "eventType": "QS",
      "eventDescription": "Men's Qualifying Singles"
    },
    "round": {
      "id": 1,
      "name": "Qualifying Round 2",
      "code": "Q2",
      "modernizedId": -29,
      "stage": 38  // rounds from final
    }
  },
  "priority": "medium",
  "metadata": {
    "source": "atp-live-proxy",
    "version": "1.0.0"
  }
}
```

### 2. `draw_player_advanced`

**When triggered:** Players advance to the next round (IsTopKnown or IsBottomKnown changes from false to true)  
**Priority:** High  
**Description:** Generated when players secure their spot in the next round

**Singles Example:**
```json
{
  "event_type": "draw_player_advanced",
  "event_timestamp": "2025-08-26T13:10:41.573Z",
  "tournament_id": "3473",
  "match_id": "MS017",
  "description": "Thiago Monteiro advanced to bottom position in Round of 32",
  "data": {
    "players": [
      {
        "name": "Thiago Monteiro",
        "playerId": "MJ08"
      }
    ],
    "toRound": "Round of 32",
    "tournament": {
      "id": "3473",
      "name": "Como, ITA",
      "phase": "main_draw",
      "drawSize": 32,
      "eventType": "MS",
      "eventDescription": "Men's Singles"
    },
    "round": {
      "id": 5,
      "name": "Round of 32",
      "code": "R32",
      "modernizedId": 3,
      "stage": 6
    },
    "advancementType": "bottom",
    "position": "bottom"
  },
  "priority": "high",
  "metadata": {
    "source": "atp-live-proxy",
    "version": "1.0.0"
  }
}
```

**Doubles Example:**
```json
{
  "event_type": "draw_player_advanced",
  "event_timestamp": "2025-08-26T13:10:41.573Z",
  "tournament_id": "3473",
  "match_id": "MD012",
  "description": "J. Smith / M. Johnson advanced to top position in Round of 16",
  "data": {
    "players": [
      {
        "name": "J. Smith",
        "playerId": "JS01"
      },
      {
        "name": "M. Johnson", 
        "playerId": "MJ02"
      }
    ],
    "toRound": "Round of 16",
    "tournament": {
      "id": "3473",
      "name": "Como, ITA",
      "phase": "main_draw",
      "drawSize": 32,
      "eventType": "MD",
      "eventDescription": "Men's Doubles"
    },
    "round": {
      "id": 4,
      "name": "Round of 16",
      "code": "R16",
      "modernizedId": 4,
      "stage": 5
    },
    "advancementType": "top",
    "position": "top"
  },
  "priority": "high",
  "metadata": {
    "source": "atp-live-proxy",
    "version": "1.0.0"
  }
}
```

### 3. `draw_round_completed`

**When triggered:** All matches in a tournament round are completed  
**Priority:** High  
**Description:** Generated when an entire round finishes, providing a list of all winners who advance

**Example:**
```json
{
  "event_type": "draw_round_completed",
  "event_timestamp": "2025-08-26T13:10:41.587Z",
  "tournament_id": "3473",
  "match_id": "round-1",
  "description": "Qualifying Round 2 completed in Men's Qualifying Singles - 6 winners advance",
  "data": {
    "round": "Qualifying Round 2",
    "winners": [
      {
        "name": "Gabi Adrian Boitan",
        "playerId": "B0C0"
      },
      {
        "name": "Gabriele Pennaforti",
        "playerId": "P0JG"
      },
      {
        "name": "Raul Brancaccio",
        "playerId": "BV24"
      }
    ],
    "tournament": {
      "id": "3473",
      "name": "Como, ITA",
      "phase": "qualifying",
      "drawSize": 24,
      "eventType": "QS",
      "eventDescription": "Men's Qualifying Singles"
    },
    "roundDetails": {
      "id": 1,
      "name": "Qualifying Round 2",
      "code": "Q2",
      "modernizedId": -29,
      "stage": 38
    },
    "matchesCompleted": 6
  },
  "priority": "high",
  "metadata": {
    "source": "atp-live-proxy",
    "version": "1.0.0"
  }
}
```



### 4. `draw_tournament_completed`

**When triggered:** The tournament winner is determined (final match completed)  
**Priority:** Critical  
**Description:** Generated when the tournament concludes with a champion determined

**Example:**
```json
{
  "event_type": "draw_tournament_completed",
  "event_timestamp": "2025-08-26T13:10:41.587Z",
  "tournament_id": "3473",
  "match_id": "MS001",
  "description": "Tournament completed: Player 1 wins Men's Singles - 6/4 6/2",
  "data": {
    "champion": {
      "name": "Winner Name",
      "playerId": "ABC1"
    },
    "finalist": {
      "name": "Runner-up Name",
      "playerId": "DEF2"
    },
    "finalScore": "6/4 6/2",
    "tournament": {
      "id": "3473",
      "name": "Tournament Name",
      "phase": "main_draw",
      "drawSize": 32,
      "eventType": "MS",
      "eventDescription": "Men's Singles"
    }
  },
  "priority": "critical",
  "metadata": {
    "source": "atp-live-proxy",
    "version": "1.0.0"
  }
}
```

## Standard Event Schema

All draw events follow this consistent structure:

```json
{
  "event_type": "draw_*",
  "event_timestamp": "2025-08-26T13:10:41.573Z",
  "tournament_id": "string",
  "match_id": "string",
  "description": "Human-readable event description",
  "data": {
    // Event-specific data fields
  },
  "priority": "low|medium|high|critical",
  "metadata": {
    "source": "atp-live-proxy",
    "version": "1.0.0"
  }
}
```

### Field Descriptions

- **`event_type`**: One of the 4 draw event types
- **`event_timestamp`**: ISO 8601 timestamp when event was generated
- **`tournament_id`**: ATP tournament ID (e.g., "3473")
- **`match_id`**: Unique match identifier (format: "MS017", "QS009", "MD012", or special identifiers for rounds)
- **`description`**: Human-readable event summary
- **`data`**: Event-specific payload with contextual information
- **`priority`**: Event importance level affecting delivery priority
- **`metadata`**: System information about event source and version

## Data Structures

### Tournament Object
```json
{
  "id": "3473",
  "name": "Como, ITA",
  "phase": "qualifying|main_draw",
  "drawSize": 32,
  "eventType": "MS|QS|MD",
  "eventDescription": "Men's Singles|Men's Qualifying Singles|Men's Doubles"
}
```

### Round Object
```json
{
  "id": 1,
  "name": "Round of 32",
  "code": "R32",  // Standardized codes: F, SF, QF, R16, R32, R64, Q1, Q2, Q3
  "modernizedId": 3,
  "stage": 6  // Rounds from final (1 = final, 2 = semifinal, etc.)
}
```

### Player Object
```json
{
  "name": "Player Full Name",
  "playerId": "ATP_ID",
  "teamId": 1  // 1 for top/first team, 2 for bottom/second team
}
```

### Doubles Match Example

For doubles matches, all four players are included in the `players` array with their respective `teamId` values:

```json
{
  "event_type": "draw_match_result",
  "event_timestamp": "2025-08-27T12:05:23.851Z",
  "tournament_id": "3473",
  "match_id": "MD010",
  "description": "Draw match completed: V. Cornea/S. Rodriguez Taverna vs F. Bondioli/C. Caniato - V. Cornea/S. Rodriguez Taverna wins 7/6(2) 7/6(6)",
  "data": {
    "resultType": "completed",
    "players": [
      {
        "name": "V. Cornea",
        "playerId": "CF25",
        "teamId": 1
      },
      {
        "name": "S. Rodriguez Taverna",
        "playerId": "RH59",
        "teamId": 1
      },
      {
        "name": "F. Bondioli",
        "playerId": "B0PE",
        "teamId": 2
      },
      {
        "name": "C. Caniato",
        "playerId": "C0LK",
        "teamId": 2
      }
    ],
    "winner": [
      {
        "name": "V. Cornea",
        "playerId": "CF25",
        "teamId": 1
      },
      {
        "name": "S. Rodriguez Taverna",
        "playerId": "RH59",
        "teamId": 1
      }
    ],
    "score": "7/6(2) 7/6(6)",
    "tournament": {
      "id": "3473",
      "name": "Como, ITA",
      "phase": "main_draw",
      "drawSize": 16,
      "eventType": "MD",
      "eventDescription": "Men's Doubles"
    },
    "round": {
      "id": 4,
      "name": "Round of 16",
      "code": "R16",
      "modernizedId": 4,
      "stage": 5
    }
  },
  "priority": "medium",
  "metadata": {
    "source": "atp-live-proxy",
    "version": "1.0.0"
  }
}
```

Note that for doubles:
- The `players` array contains all 4 players (2 per team)
- The `winner` field is an array containing both winning partners
- Players on the same team share the same `teamId`
- The description shows both partners separated by "/"

## Tournament Context

### Tournament Types
- **MS**: Men's Singles main draw
- **QS**: Men's Qualifying Singles
- **MD**: Men's Doubles
- **WS**: Women's Singles (when supported)
- **WD**: Women's Doubles (when supported)

### Match ID Format
- Main draw singles: `MS001`, `MS002`, etc.
- Qualifying singles: `QS001`, `QS002`, etc.
- Men's doubles: `MD001`, `MD002`, etc.
- Special identifiers: `round-1`, `semifinal-set`, `final-set`

### Round Codes
- **F**: Final
- **SF**: Semifinals
- **QF**: Quarterfinals
- **R16**: Round of 16
- **R32**: Round of 32
- **R64**: Round of 64
- **R128**: Round of 128
- **Q1**: Qualifying Round 1
- **Q2**: Qualifying Round 2
- **Q3**: Qualifying Round 3

### Tournament Phases
- **main_draw**: Main tournament draw
- **qualifying**: Qualifying rounds

## Score Format
- Standard format: "6/4 6/2", "7/5 3/6 6/3"
- Tiebreak notation: "7/6(5)", "6/7(3) 7/6(8)"
- Walkover/retirement: "4/2 RET", "W/O", "DEF"

## Result Types (for draw_match_result)
- **completed**: Normal match completion
- **walkover**: Match ended via walkover, retirement, or default

## Event Priorities

- **Critical**: Tournament completion
- **High**: Round completion, player advancement
- **Medium**: Individual match completion

## Implementation Notes

1. **Real-time Detection**: Events are generated by comparing current draw data with previous state
2. **Change-based Logic**: Only fires when specific field changes occur (Winner, IsTopKnown, IsBottomKnown)
3. **Context Preservation**: All events include comprehensive tournament and round context
4. **Multi-tournament Support**: Handles multiple simultaneous tournaments and event types
5. **Data Consistency**: Player names and IDs are extracted directly from ATP API responses
6. **Error Handling**: Graceful handling of missing or incomplete draw data

## Migration Guide

### From v2.0.0 to v2.1.0

#### New Features
1. **teamId field**: All player objects now include `teamId` (1 or 2)
2. **Complete doubles data**: Doubles matches now include all 4 players in the `players` array
3. **Array winner for doubles**: The `winner` field is an array for doubles matches

#### Example Updates
```javascript
// v2.0.0 - Doubles only showed one player per team
if (event.data.players.length === 2) {
  // Singles or incomplete doubles data
}

// v2.1.0 - Doubles show all players with teamId
if (event.data.players.length === 4) {
  // Doubles match
  const team1 = event.data.players.filter(p => p.teamId === 1);
  const team2 = event.data.players.filter(p => p.teamId === 2);
}

// Check if winner is doubles
const isDoubles = Array.isArray(event.data.winner);
```

### From v1.0.0 to v2.0.0

### Breaking Changes
1. **Event types consolidated**: 
   - `draw_match_completed` and `draw_match_walkover` → `draw_match_result` (check `resultType` field)
   
2. **Player data normalized**:
   - String arrays replaced with player objects
   - `nationality`, `seed`, `ranking` removed from player objects
   - `winners` in round_completed events now array of player objects

3. **Tournament/Round context enhanced**:
   - Simple string fields replaced with structured objects
   - New `tournament` and `round` objects with comprehensive metadata

### Example Migration
```javascript
// Old format (v1.0.0)
if (event.event_type === 'draw_match_completed' || event.event_type === 'draw_match_walkover') {
  const winner = event.data.winner; // string
  const tournament = event.data.tournament; // string
}

// New format (v2.0.0)
if (event.event_type === 'draw_match_result') {
  const isWalkover = event.data.resultType === 'walkover';
  const winner = event.data.winner; // object with {name, playerId}
  const tournament = event.data.tournament; // object with {id, name, phase, drawSize, etc.}
}
```

## Live Match Event Consistency

As of v2.1.0, live match events (e.g., `match_started`, `score_update`, `match_completed`) now include the same `teamId` field for complete data consistency with draw events:

```json
{
  "event_type": "match_started",
  "data": {
    "players": [
      {
        "name": "V. Cornea",
        "playerId": "CF25",
        "teamId": 1
      },
      {
        "name": "S. Rodriguez Taverna", 
        "playerId": "RH59",
        "teamId": 1
      },
      {
        "name": "F. Bondioli",
        "playerId": "B0PE", 
        "teamId": 2
      },
      {
        "name": "C. Caniato",
        "playerId": "C0LK",
        "teamId": 2
      }
    ]
  }
}
```

**Key Features:**
- Both singles and doubles live matches include `teamId` (1 for first team, 2 for second team)
- Doubles matches use space-saving first initials for player names
- Complete structural consistency between draw events and live match events
- Same player object schema: `{name, playerId, teamId}`

## Webhook Delivery

Events are delivered via webhook in the order they're generated, with retry logic for failed deliveries. Higher priority events may receive preferential delivery treatment depending on your webhook configuration.

### Webhook Payload Structure

When events are delivered via webhook, the payload includes both the original event timestamp and a webhook delivery timestamp:

```json
{
  "event_type": "draw_match_result",
  "event_timestamp": "2025-08-26T08:45:02.124Z",  // Original event time (preserved from logs)
  "timestamp": "2025-08-27T16:44:06.844Z",        // Webhook delivery time (for HMAC signature)
  "tournament_id": "3473",
  "match_id": "MS031",
  "description": "...",
  "data": { ... }
}
```

**Important Notes:**
- **`event_timestamp`**: The original time when the event occurred (preserved from log data during replay)
- **`timestamp`**: The current time when the webhook is delivered (required for HMAC signature verification)
- Both timestamps are included to preserve historical accuracy while enabling proper webhook authentication